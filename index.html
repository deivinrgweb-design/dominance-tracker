<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dominance Tracker • 12-Week Home Fitness</title>
  <meta name="theme-color" content="#1a1a1a" />
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg:#0f0f10;
      --bg-elev:#1a1a1a;
      --text:#ffffff;
      --muted:#b3b3b3;
      --accent:#C0392B;
      --accent-2:#E74C3C;
      --success:#27AE60;
      --warn:#F39C12;
      --danger:#E74C3C;
      --card:#151515;
      --border:#2a2a2a;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --radius-sm:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:linear-gradient(180deg, #0b0b0c 0%, var(--bg) 60%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .app{max-width:980px;margin:0 auto;display:flex;flex-direction:column;height:100dvh;padding-bottom:72px}
    header{
      position:sticky;top:0;z-index:10;background:rgba(16,16,17,.65);backdrop-filter: blur(12px);
      border-bottom:1px solid var(--border);
    }
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 16px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:34px;height:34px;border-radius:10px;background:radial-gradient(120% 120% at 20% 20%, #c0392b 0%, #8e1e17 50%, #2b0b09 100%);box-shadow:inset 0 0 12px rgba(255,255,255,.1), 0 8px 24px rgba(192,57,43,.35)}
    .brand h1{font-size:16px;margin:0;letter-spacing:.4px}
    .today-brief{font-size:12px;color:var(--muted)}
    .pill{font-size:11px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:linear-gradient(180deg,#191919,#121212)}

    main{flex:1;overflow:auto;scroll-behavior:smooth}
    .container{padding:16px;display:grid;gap:16px}
    .card{background:linear-gradient(180deg,#141415 0%, #101011 100%);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:16px}
    .card .content{padding:14px 16px}

    .grid-2{display:grid;gap:12px}
    @media(min-width:720px){.grid-2{grid-template-columns:1fr 1fr}}

    .exercise{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:10px;border-radius:12px;border:1px solid var(--border);background:linear-gradient(180deg,#161616,#111)}
    .exercise .name{font-weight:700}
    .exercise .meta{font-size:12px;color:var(--muted)}
    .exercise input[type="checkbox"]{width:20px;height:20px;accent-color:var(--success)}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:10px;border:1px solid var(--border);font-size:12px}

    .timer{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .time{font-size:28px;font-weight:800}
    .timer .ring{height:8px;background:#222;border-radius:999px;overflow:hidden;flex:1}
    .timer .ring>span{display:block;height:100%;width:0;background:var(--success);transition:width .2s ease, background .2s ease}
    .timer .actions button{background:#181818;border:1px solid var(--border);border-radius:12px;padding:10px 14px;color:var(--text)}

    .bar{height:12px;background:#222;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
    .bar>span{display:block;height:100%;width:0;background:var(--success);transition:width .25s ease, background .25s ease}

    nav.tabs{position:fixed;bottom:0;left:0;right:0;background:rgba(18,18,19,.85);backdrop-filter: blur(10px);border-top:1px solid var(--border);display:grid;grid-template-columns:repeat(5,1fr);z-index:20}
    .tab{display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;padding:8px 4px;color:var(--muted);text-decoration:none;font-size:11px}
    .tab.active{color:#fff}
    .tab svg{width:22px;height:22px}

    .btn{background:linear-gradient(180deg,#2b0f0c,#180807);color:#fff;border:1px solid #3a1410;padding:12px 14px;border-radius:12px;box-shadow:0 6px 18px rgba(231,76,60,.2);font-weight:700}
    .btn.ghost{background:#141414;border-color:var(--border);box-shadow:none}
    .btn.success{background:linear-gradient(180deg,#0f291b,#07140d);border-color:#123d28}

    .muted{color:var(--muted)}
    .kpi{font-weight:800}
    .small{font-size:12px}

    input, select, textarea{width:100%;background:#121212;border:1px solid var(--border);border-radius:10px;padding:10px;color:#fff}
    label{font-size:12px;color:var(--muted)}

    .flex{display:flex;gap:12px}
    .space{height:8px}
    .center{text-align:center}
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>Dominance Tracker</h1>
            <div class="today-brief" id="todayBrief">Caricamento…</div>
          </div>
        </div>
        <button class="pill" id="installBtn" hidden>Installa App</button>
      </div>
    </header>

    <main>
      <section class="container" id="tab-workout" role="tabpanel" aria-labelledby="nav-workout">
        <div class="card" id="todayCard">
          <h2>Today's Workout</h2>
          <div class="content" id="todayContent"></div>
        </div>

        <div class="card">
          <h2>Timer</h2>
          <div class="content">
            <div class="timer">
              <div class="time" id="timerDisplay">00:00</div>
              <div class="ring"><span id="timerProgress"></span></div>
              <div class="actions">
                <button id="timerStart" class="btn">Start</button>
              </div>
            </div>
            <div class="space"></div>
            <div class="row">
              <button id="timerStop" class="btn ghost">Stop</button>
              <button id="timerReset" class="btn ghost">Reset</button>
            </div>
          </div>
        </div>
      </section>

      <section class="container" id="tab-nutrition" hidden role="tabpanel" aria-labelledby="nav-nutrition">
        <div class="card">
          <h2>Nutrition Tracker</h2>
          <div class="content" id="mealsContent"></div>
        </div>
        <div class="card">
          <h2>Macros Oggi</h2>
          <div class="content" id="macrosContent"></div>
        </div>
        <div class="card">
          <h2>Aggiungi Pasto</h2>
          <div class="content">
            <div class="grid-2">
              <div>
                <label>Nome</label>
                <input id="mealName" placeholder="Pasto custom" />
              </div>
              <div>
                <label>Ora</label>
                <input id="mealTime" type="time" />
              </div>
            </div>
            <div class="grid-2">
              <div><label>Proteine (g)</label><input id="mealP" type="number" min="0" value="0" /></div>
              <div><label>Carbs (g)</label><input id="mealC" type="number" min="0" value="0" /></div>
            </div>
            <div class="grid-2">
              <div><label>Grassi (g)</label><input id="mealF" type="number" min="0" value="0" /></div>
              <div><label>Kcal</label><input id="mealK" type="number" min="0" value="0" /></div>
            </div>
            <div class="space"></div>
            <button class="btn" id="addMeal">Aggiungi</button>
          </div>
        </div>
      </section>

      <section class="container" id="tab-progress" hidden role="tabpanel" aria-labelledby="nav-progress">
        <div class="card">
          <h2>Progress Settimanale</h2>
          <div class="content" id="progressForm"></div>
        </div>
        <div class="card">
          <h2>Foto Progresso</h2>
          <div class="content" id="photosContent">
            <div class="grid-2">
              <div>
                <label>Week 0 (Baseline)</label>
                <input type="file" accept="image/*" data-photokey="w0" />
                <div class="space"></div>
                <img id="img-w0" style="max-width:100%;border-radius:12px;border:1px solid var(--border)" />
              </div>
              <div>
                <label>Week 4</label>
                <input type="file" accept="image/*" data-photokey="w4" />
                <div class="space"></div>
                <img id="img-w4" style="max-width:100%;border-radius:12px;border:1px solid var(--border)" />
              </div>
            </div>
            <div class="space"></div>
            <div class="grid-2">
              <div>
                <label>Week 8</label>
                <input type="file" accept="image/*" data-photokey="w8" />
                <div class="space"></div>
                <img id="img-w8" style="max-width:100%;border-radius:12px;border:1px solid var(--border)" />
              </div>
              <div>
                <label>Week 12</label>
                <input type="file" accept="image/*" data-photokey="w12" />
                <div class="space"></div>
                <img id="img-w12" style="max-width:100%;border-radius:12px;border:1px solid var(--border)" />
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>Grafico Peso</h2>
          <div class="content"><canvas id="weightChart" height="240"></canvas><div id="chartFallback" class="small muted" style="margin-top:8px;display:none">Impossibile caricare Chart.js – il grafico sarà disattivato offline se la libreria non è in cache.</div></div>
        </div>
        <div class="card">
          <h2>Stats</h2>
          <div class="content" id="statsContent"></div>
        </div>
      </section>

      <section class="container" id="tab-settings" hidden role="tabpanel" aria-labelledby="nav-settings">
        <div class="card">
          <h2>Profilo</h2>
          <div class="content">
            <div class="grid-2">
              <div><label>Nome</label><input id="uName" value="MagnetiqStudio" /></div>
              <div><label>Età</label><input id="uAge" type="number" value="24" /></div>
            </div>
            <div class="grid-2">
              <div><label>Altezza (cm)</label><input id="uHeight" type="number" value="190" /></div>
              <div><label>Peso iniziale (kg)</label><input id="uStartW" type="number" value="74" /></div>
            </div>
            <div class="grid-2">
              <div><label>Body Fat (%)</label><input id="uBf" type="number" step="0.1" value="10.5" /></div>
              <div><label>Goal (kg)</label><input id="uGoal" type="number" value="78" /></div>
            </div>
            <div class="space"></div>
            <div class="row">
              <button class="btn success" id="saveProfile">Salva</button>
              <button class="btn ghost" id="toggleTheme">Dark/Light</button>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>Fasi & Debug</h2>
          <div class="content" id="phaseContent"></div>
        </div>
        <div class="card">
          <h2>Backup</h2>
          <div class="content">
            <div class="row">
              <button class="btn" id="exportBtn">Esporta JSON</button>
              <label class="btn ghost" for="importFile" style="display:inline-block;cursor:pointer">Importa JSON</label>
              <input id="importFile" type="file" accept="application/json" hidden />
            </div>
            <div class="space"></div>
            <button class="btn ghost" id="resetAll">Reset App</button>
          </div>
        </div>
      </section>

      <section class="container" id="tab-info" hidden role="tabpanel" aria-labelledby="nav-info">
        <div class="card">
          <h2>Protocollo • 4 Fasi</h2>
          <div class="content" id="infoContent"></div>
        </div>
      </section>
    </main>

    <nav class="tabs" role="tablist">
      <a class="tab active" id="nav-workout" href="#" data-tab="workout" aria-selected="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 6h12v12H6z" stroke-width="2"/><path d="M9 9h6v6H9z"/></svg>
        <span>Workout</span>
      </a>
      <a class="tab" id="nav-nutrition" href="#" data-tab="nutrition">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 3v18" stroke-width="2"/><path d="M6 8h12M6 16h12"/></svg>
        <span>Nutrition</span>
      </a>
      <a class="tab" id="nav-progress" href="#" data-tab="progress">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 20V10" stroke-width="2"/><path d="M10 20V4" stroke-width="2"/><path d="M16 20v-6" stroke-width="2"/><path d="M22 20V8" stroke-width="2"/></svg>
        <span>Progress</span>
      </a>
      <a class="tab" id="nav-settings" href="#" data-tab="settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z" stroke-width="2"/><path d="M3 12h3l2-3 4-2 4 2 2 3h3"/></svg>
        <span>Settings</span>
      </a>
      <a class="tab" id="nav-info" href="#" data-tab="info">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9" stroke-width="2"/><path d="M12 8h.01M11 12h2v4h-2z"/></svg>
        <span>Info</span>
      </a>
    </nav>
  </div>

  <script>
    // Chart.js CDN fallbacks
    const CHART_CDNS = [
      'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js',
      'https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js'
    ];
    function loadChartJS(){
      if(window.Chart) return Promise.resolve();
      let i = 0;
      return new Promise((resolve, reject)=>{
        const tryNext = ()=>{
          if(i>=CHART_CDNS.length){ reject(new Error('Chart.js not available')); return; }
          const src = CHART_CDNS[i++];
          const s = document.createElement('script');
          s.src = src; s.defer = true; s.onload = ()=> window.Chart?resolve():reject(new Error('Chart global missing'));
          s.onerror = tryNext; document.head.appendChild(s);
        };
        tryNext();
      });
    }
  </script>

  <script>
  // ========= UTIL & CONSTANTS =========
  const TOTAL_WEEKS = 12;
  const DAY_MS = 86400000;
  const IT_DAYS = ['Domenica','Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato'];

  // Dynamic start: next Monday from today
  function getNextMonday(){
    const now = new Date();
    const day = now.getDay(); // 0..6, 1 = Monday?
    const diff = (8 - (day===0?7:day)) % 7; // days to next Monday
    const next = new Date(now.getFullYear(), now.getMonth(), now.getDate() + (diff===0?7:diff));
    next.setHours(0,0,0,0);
    return toISO(next);
  }
  const START_ISO = getNextMonday();
  const END_ISO   = toISO(new Date(new Date(START_ISO).getTime() + (TOTAL_WEEKS*7-1)*DAY_MS));

  const PHASES = [
    {id:1,name:'Re-adaptation',weeks:[1,2],rpe:'5-6',desc:'Form perfetta, CNS reset.', days:['Lunedì','Mercoledì','Venerdì']},
    {id:2,name:'Building',weeks:[3,4,5,6],rpe:'6-7',desc:'Progressive overload, volume in aumento.', days:['Lunedì','Martedì','Giovedì','Sabato']},
    {id:3,name:'Peak Recovery',weeks:[7,8,9,10],rpe:'7-8',desc:'Approaching PRs, massimo sforzo.', days:['Lunedì','Martedì','Giovedì','Sabato']},
    {id:4,name:'Dominance',weeks:[11,12],rpe:'4-8',desc:'Week 11 deload, Week 12 PR WEEK.', days:['Lunedì','Martedì','Giovedì','Sabato']},
  ];

  const MEALS_BASE = [
    {name:'Colazione', time:'08:00', p:25, c:50, f:12, kcal:408, note:'Ufficio'},
    {name:'Mid-morning', time:'10:30', p:20, c:40, f:3,  kcal:267},
    {name:'Pranzo', time:'13:00', p:40, c:80, f:10, kcal:570, note:'Ufficio'},
    {name:'Pre-workout', time:'17:30', p:20, c:50, f:2,  kcal:298, note:'30m prima WO'},
    {name:'Post-workout', time:'19:00', p:35, c:70, f:5,  kcal:465, note:'entro 30m'},
    {name:'Cena', time:'20:15', p:35, c:60, f:15, kcal:515},
    {name:'Pre-sleep', time:'22:30', p:25, c:30, f:3,  kcal:247},
  ];
  const TARGETS = { kcal:2892, p:146, c:380, f:50 };

  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  const toISO = d=> {const x=new Date(d); x.setMinutes(x.getMinutes()-x.getTimezoneOffset()); return x.toISOString().slice(0,10);}
  const parseISO = iso=>{const [y,m,da]=iso.split('-').map(Number);return new Date(y,m-1,da)};
  const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));

  function weekFromDate(iso){
    const start = parseISO(START_ISO);
    const cur = parseISO(iso);
    const diff = Math.floor((cur - start)/DAY_MS);
    const w = Math.floor(diff/7)+1;
    return clamp(w,1,TOTAL_WEEKS);
  }
  function phaseFromWeek(w){
    if(w<=2) return PHASES[0];
    if(w<=6) return PHASES[1];
    if(w<=10) return PHASES[2];
    return PHASES[3];
  }

  // ========= WORKOUT PLAN =========
  function exercisesFor(week, dayName){
    // (Same sets as the source file)
    const F1_A = [
      {n:'Pull-ups', sets:3, reps:'5-6', rpe:'5-6', rest:120},
      {n:'Dumbbell Bench Press', sets:3, reps:'8', rpe:'5-6', rest:90},
      {n:'Dumbbell Rows (Bilaterale)', sets:3, reps:'10', rpe:'5-6', rest:60},
      {n:'Dips', sets:3, reps:'8-10', rpe:'5-6', rest:90},
      {n:'Pike Push-ups', sets:2, reps:'10', rpe:'5', rest:60},
    ];
    const F1_B = [
      {n:'Goblet Squat', sets:3, reps:'12', rpe:'5-6', rest:90},
      {n:'Single Leg Deadlift', sets:3, reps:'10/side', rpe:'6', rest:60, note:'Per lato'},
      {n:"Farmer's Carry", sets:3, reps:'30 passi', rpe:'5-6', rest:60},
      {n:'Dumbbell Step-ups', sets:3, reps:'12/side', rpe:'5-6', rest:60},
      {n:'Plank', sets:2, reps:'30 sec', rpe:'5', rest:0},
    ];
    const F1_C = [
      {n:'Pull-ups', sets:3, reps:'6-8', rpe:'5-6', rest:120},
      {n:'Dumbbell Shoulder Press', sets:3, reps:'10', rpe:'5-6', rest:90},
      {n:'Dumbbell Curl', sets:3, reps:'12', rpe:'5', rest:60},
      {n:'Tricep Dips', sets:3, reps:'10-12', rpe:'5-6', rest:90},
      {n:'Dumbbell Flye', sets:2, reps:'12', rpe:'5', rest:60},
    ];

    const F2_U = [
      {n:'Pull-ups', sets:4, reps:'5-7', rpe:'7', rest:150},
      {n:'Dumbbell Bench Press', sets:4, reps:'6-8', rpe:'6-7', rest:90},
      {n:'Dumbbell Rows', sets:4, reps:'6-8', rpe:'6-7', rest:90},
      {n:'Dips', sets:3, reps:'8-10', rpe:'6-7', rest:90},
    ];
    const F2_L = [
      {n:'Goblet Squat', sets:4, reps:'8-10', rpe:'7', rest:120},
      {n:'Single Leg Deadlift', sets:3, reps:'10/side', rpe:'6-7', rest:90},
      {n:"Farmer's Carry Heavy", sets:3, reps:'40 passi', rpe:'6-7', rest:60},
      {n:'Dumbbell Step-ups', sets:3, reps:'12/side', rpe:'6', rest:60},
    ];
    const F2_UH = [
      {n:'Pull-ups', sets:4, reps:'8-10', rpe:'7', rest:120},
      {n:'Dumbbell Shoulder Press', sets:4, reps:'8-10', rpe:'6-7', rest:90},
      {n:'Dumbbell Flye', sets:3, reps:'10-12', rpe:'6', rest:60},
      {n:'Dumbbell Curl', sets:3, reps:'10-12', rpe:'6', rest:60},
      {n:'Tricep Extension', sets:2, reps:'12', rpe:'5-6', rest:60},
    ];
    const F2_LH = [
      {n:'Goblet Squat', sets:4, reps:'10-12', rpe:'7', rest:90},
      {n:'Single Leg RDL', sets:3, reps:'10/side', rpe:'6-7', rest:60},
      {n:"Farmer's Carry Moderate", sets:3, reps:'60 passi', rpe:'6', rest:60},
      {n:'Bulgarian Split Squat', sets:3, reps:'10/side', rpe:'6', rest:60},
    ];

    const F3_U = [
      {n:'Pull-ups', sets:5, reps:'5-8', rpe:'8', rest:180},
      {n:'Dumbbell Bench Press', sets:4, reps:'6-8', rpe:'7-8', rest:120},
      {n:'Dumbbell Rows', sets:4, reps:'6-8', rpe:'7-8', rest:120},
      {n:'Dips', sets:4, reps:'8-10', rpe:'7-8', rest:120},
    ];
    const F3_L = [
      {n:'Goblet Squat', sets:5, reps:'6-8', rpe:'8', rest:150},
      {n:'Single Leg Deadlift', sets:4, reps:'8/side', rpe:'7-8', rest:120},
      {n:"Farmer's Carry Heavy", sets:3, reps:'50 passi', rpe:'7', rest:90},
      {n:'Bulgarian Split Squat', sets:3, reps:'10/side', rpe:'7', rest:90},
    ];
    const F3_UH = [
      {n:'Pull-ups', sets:4, reps:'10-12', rpe:'7', rest:120},
      {n:'Dumbbell Shoulder Press', sets:4, reps:'10-12', rpe:'7', rest:90},
      {n:'Dumbbell Flye', sets:3, reps:'12-15', rpe:'6-7', rest:60},
      {n:'Dumbbell Curl', sets:3, reps:'12-15', rpe:'6', rest:60},
      {n:'Tricep Dips', sets:3, reps:'12-15', rpe:'6-7', rest:60},
    ];
    const F3_LH = [
      {n:'Goblet Squat', sets:4, reps:'12-15', rpe:'7', rest:90},
      {n:'Single Leg RDL', sets:3, reps:'12-15/side', rpe:'7', rest:60},
      {n:"Farmer's Carry Heavy", sets:3, reps:'70 passi', rpe:'6-7', rest:60},
      {n:'Bulgarian Split Squat', sets:3, reps:'12/side', rpe:'6-7', rest:60},
    ];

    const F4_W11_U = [
      {n:'Pull-ups', sets:3, reps:'5-6', rpe:'6-7', rest:120},
      {n:'Dumbbell Bench', sets:3, reps:'6-8', rpe:'6-7', rest:90},
      {n:'Dumbbell Rows', sets:3, reps:'6-8', rpe:'6-7', rest:90},
      {n:'Dips', sets:3, reps:'8-10', rpe:'6-7', rest:90},
    ];
    const F4_W11_L = [
      {n:'Goblet Squat', sets:3, reps:'8-10', rpe:'6-7', rest:90},
      {n:'Single Leg Deadlift', sets:3, reps:'8-10/side', rpe:'6-7', rest:90},
      {n:"Farmer's Carry", sets:3, reps:'50 passi', rpe:'6', rest:60},
      {n:'Bulgarian Split Squat', sets:2, reps:'10/side', rpe:'6', rest:60},
    ];
    const F4_W12_U = [
      {n:'Pull-ups', sets:4, reps:'5-6 (GOAL 12+)', rpe:'8', rest:120},
      {n:'Dumbbell Bench Press', sets:4, reps:'6-8', rpe:'7-8', rest:120},
      {n:'Dumbbell Rows', sets:4, reps:'6-8', rpe:'7-8', rest:120},
      {n:'Dips', sets:4, reps:'8-10 (GOAL 15+)', rpe:'7-8', rest:120},
    ];
    const F4_W12_L = [
      {n:'Goblet Squat', sets:4, reps:'10-12 (GOAL 15+)', rpe:'8', rest:90},
      {n:'Single Leg Deadlift', sets:4, reps:'8-10/side', rpe:'7-8', rest:120},
      {n:"Farmer's Carry Heavy", sets:3, reps:'50+ passi', rpe:'7-8', rest:60},
      {n:'Bulgarian Split Squat', sets:3, reps:'10-12/side', rpe:'6-7', rest:60},
    ];
    const F4_W12_UH = [
      {n:'Pull-ups', sets:4, reps:'10-12', rpe:'7', rest:120},
      {n:'Dumbbell Shoulder Press', sets:4, reps:'10-12', rpe:'7-8', rest:90},
      {n:'Dumbbell Curl', sets:3, reps:'12-15', rpe:'6-7', rest:60},
      {n:'Tricep Dips', sets:3, reps:'12-15 (GOAL 20+)', rpe:'7-8', rest:90},
    ];
    const F4_W12_LH = [
      {n:'Goblet Squat', sets:4, reps:'12-15', rpe:'7', rest:90},
      {n:'Single Leg RDL', sets:3, reps:'12-15/side', rpe:'7', rest:60},
      {n:"Farmer's Carry HEAVY", sets:3, reps:'70+ passi', rpe:'7-8', rest:60},
    ];

    if(phaseFromWeek(week).id===1){
      if(dayName==='Lunedì') return F1_A;
      if(dayName==='Mercoledì') return F1_B;
      if(dayName==='Venerdì') return F1_C;
      return [];
    }
    if(phaseFromWeek(week).id===2){
      if(dayName==='Lunedì') return F2_U;
      if(dayName==='Martedì') return F2_L;
      if(dayName==='Giovedì') return F2_UH;
      if(dayName==='Sabato') return F2_LH;
      return [];
    }
    if(phaseFromWeek(week).id===3){
      if(dayName==='Lunedì') return F3_U;
      if(dayName==='Martedì') return F3_L;
      if(dayName==='Giovedì') return F3_UH;
      if(dayName==='Sabato') return F3_LH;
      return [];
    }
    if(week===11){
      if(dayName==='Lunedì') return F4_W11_U;
      if(dayName==='Martedì') return F4_W11_L;
      if(dayName==='Giovedì') return F4_W11_U;
      if(dayName==='Sabato') return F4_W11_L;
      return [];
    }
    if(dayName==='Lunedì') return F4_W12_U;
    if(dayName==='Martedì') return F4_W12_L;
    if(dayName==='Giovedì') return F4_W12_UH;
    if(dayName==='Sabato') return F4_W12_LH;
    return [];
  }

  function buildPlan(){
    const start = parseISO(START_ISO);
    const end = parseISO(END_ISO);
    const planByDate = {};
    for(let t=start; t<=end; t=new Date(t.getTime()+DAY_MS)){
      const iso = toISO(t);
      const week = weekFromDate(iso);
      const phase = phaseFromWeek(week);
      const dayName = IT_DAYS[t.getDay()];
      let workoutName = '';
      if(phase.id===1){
        if(dayName==='Lunedì') workoutName='Workout A Upper';
        if(dayName==='Mercoledì') workoutName='Workout B Lower';
        if(dayName==='Venerdì') workoutName='Workout C Upper Lite';
      }
      if(phase.id===2){
        if(dayName==='Lunedì') workoutName='Upper Strength';
        if(dayName==='Martedì') workoutName='Lower Power';
        if(dayName==='Giovedì') workoutName='Upper Hypertrophy';
        if(dayName==='Sabato') workoutName='Lower Hypertrophy';
      }
      if(phase.id===3){
        if(dayName==='Lunedì') workoutName='Upper Strength PEAK';
        if(dayName==='Martedì') workoutName='Lower Power PEAK';
        if(dayName==='Giovedì') workoutName='Upper Hypertrophy PEAK';
        if(dayName==='Sabato') workoutName='Lower Hypertrophy PEAK';
      }
      if(phase.id===4){
        if(week===11){
          if(dayName==='Lunedì') workoutName='Upper Deload';
          if(dayName==='Martedì') workoutName='Lower Deload';
          if(dayName==='Giovedì') workoutName='Upper Deload';
          if(dayName==='Sabato') workoutName='Lower Deload';
        } else {
          if(dayName==='Lunedì') workoutName='Upper FINAL';
          if(dayName==='Martedì') workoutName='Lower FINAL';
          if(dayName==='Giovedì') workoutName='Upper FINAL';
          if(dayName==='Sabato') workoutName='Lower FINAL';
        }
      }
      const list = exercisesFor(week, dayName);
      planByDate[iso] = {week, phase:phase.name, phaseId:phase.id, dayName, workoutName, exercises:list};
    }
    return planByDate;
  }

  const PLAN = buildPlan();

  // ========= STORAGE =========
  const store = {
    get(k,def){try{const v=localStorage.getItem(k);return v?JSON.parse(v):def}catch(e){return def}},
    set(k,v){localStorage.setItem(k,JSON.stringify(v))},
    del(k){localStorage.removeItem(k)}
  };

  // ========= TODAY =========
  function renderToday(){
    const now = new Date();
    const iso = toISO(now);
    const today = PLAN[iso];
    const brief = today
      ? `Oggi ${iso} · Week ${today.week}/12 · Phase ${today.phaseId}: ${today.phase}`
      : `Oggi ${iso} · Fuori protocollo`;
    document.getElementById('todayBrief').textContent = brief;

    const c = document.getElementById('todayContent');
    c.innerHTML = '';
    if(!today){
      c.innerHTML = `<div class="center">Nessun dato piano per oggi</div>`;return;
    }
    const isWorkoutDay = today.exercises && today.exercises.length>0;
    if(!isWorkoutDay){
      c.innerHTML = `
        <div class="center">
          <div class="kpi" style="font-size:20px">TODAY IS A REST DAY · Recovery Mode</div>
          <div class="space"></div>
          <div class="muted">Prossimo workout: consulta le Info oppure apri Nutrition</div>
          <div class="space"></div>
          <a class="btn" href="#" onclick="openTab('nutrition')">Vai a Nutrition</a>
        </div>`;
      return;
    }
    const title = `${today.dayName} · ${today.workoutName}`;
    c.insertAdjacentHTML('beforeend', `<div class="row"><span class="chip">${title}</span><span class="chip">RPE target: ${phaseFromWeek(today.week).rpe}</span></div>`);

    const doneMap = store.get('done:'+iso,{});

    today.exercises.forEach((ex,idx)=>{
      const id = `ex-${idx}`;
      const checked = !!doneMap[id];
      const block = document.createElement('div');
      block.className = 'exercise';
      block.innerHTML = `
        <input type="checkbox" ${checked?'checked':''} id="${id}" />
        <div>
          <div class="name">${ex.n}</div>
          <div class="meta">${ex.sets}x${ex.reps} · RPE ${ex.rpe} · Rest ${ex.rest}s ${ex.note?('· '+ex.note):''}</div>
        </div>
        <div class="chip">${Math.max(6,Math.round(ex.sets*ex.rest/30))} min</div>
      `;
      block.querySelector('input').addEventListener('change', (e)=>{
        doneMap[id] = e.target.checked;
        store.set('done:'+iso,doneMap);
      });
      c.appendChild(block);
    });

    const footer = document.createElement('div');
    footer.className='row';
    footer.innerHTML = `<button class="btn success" id="completeBtn">Workout Complete</button>`;
    c.appendChild(document.createElement('div')).className='space';
    c.appendChild(footer);

    document.getElementById('completeBtn').onclick = ()=>{
      const all = c.querySelectorAll(`input[type='checkbox']`);
      all.forEach(ch=>ch.checked=true);
      store.set('done:'+iso, Object.fromEntries(Array.from(all).map((ch,i)=>['ex-'+i,true])));
      store.set('workout:completedAt:'+iso, new Date().toISOString());
      alert('Workout salvato! Ottimo lavoro.');
    };
  }

  // ========= TIMER =========
  let tStart=null, tInt=null, elapsed=0;
  const LIMIT = 60*60*1000;
  function updateTimerUI(){
    const mm = String(Math.floor(elapsed/60000)).padStart(2,'0');
    const ss = String(Math.floor((elapsed%60000)/1000)).padStart(2,'0');
    document.getElementById('timerDisplay').textContent = `${mm}:${ss}`;
    const p = clamp(elapsed/LIMIT,0,1);
    const bar = document.getElementById('timerProgress');
    bar.style.width = `${p*100}%`;
    if(p<0.75) bar.style.background = 'var(--success)';
    else if(p<0.92) bar.style.background = 'var(--warn)';
    else bar.style.background = 'var(--danger)';
  }
  function startTimer(){
    if(tInt) return; tStart = Date.now()-elapsed;
    tInt = setInterval(()=>{
      elapsed = Date.now()-tStart; updateTimerUI();
      if(elapsed>=LIMIT){
        clearInterval(tInt); tInt=null; elapsed=LIMIT; updateTimerUI();
        try{ new AudioContext().resume(); }catch{}
        alert('⚠️ 55+ min! Chiudi in sicurezza.');
      }
    },250);
  }
  function stopTimer(){ if(tInt){clearInterval(tInt); tInt=null;} }
  function resetTimer(){ stopTimer(); elapsed=0; updateTimerUI(); }

  // ========= NUTRITION =========
  function dayKey(){ return 'day:'+toISO(new Date()); }
  function getDayData(){ return store.get(dayKey(), {meals:[...MEALS_BASE], logged:{}}); }
  function saveDayData(d){ store.set(dayKey(), d); renderMeals(); renderMacros(); }

  function renderMeals(){
    const box = document.getElementById('mealsContent'); box.innerHTML='';
    const dd = getDayData();
    dd.meals.forEach((m,i)=>{
      const id = 'm'+i; const checked = !!dd.logged[id];
      const row = document.createElement('div'); row.className='exercise';
      row.innerHTML = `
        <input type="checkbox" id="${id}" ${checked?'checked':''} />
        <div>
          <div class="name">${m.name} <span class="muted">${m.time||''}</span></div>
          <div class="meta">P ${m.p} · C ${m.c} · F ${m.f} · ${m.kcal} kcal ${m.note?('· '+m.note):''}</div>
        </div>
        <div class="chip">${m.kcal} kcal</div>`;
      row.querySelector('input').addEventListener('change',(e)=>{
        dd.logged[id]=e.target.checked; saveDayData(dd);
      });
      box.appendChild(row);
    });
  }
  function renderMacros(){
    const el = document.getElementById('macrosContent'); el.innerHTML='';
    const dd = getDayData();
    let P=0,C=0,F=0,K=0; Object.entries(dd.logged).forEach(([id,on])=>{if(on){const m=dd.meals[+id.slice(1)]; P+=m.p; C+=m.c; F+=m.f; K+=m.kcal;}});

    function row(label, val, max, unit){
      const pct = clamp(val/max,0,1), color = pct<.8?'var(--danger)':(pct<1?'var(--warn)':'var(--success)');
      return `
        <div class="row" style="align-items:center;justify-content:space-between">
          <div>${label}: <span class="kpi">${Math.round(val)}${unit}</span> / ${max}${unit}</div>
          <div style="min-width:120px">${Math.round(pct*100)}%</div>
        </div>
        <div class="bar"><span style="width:${pct*100}%;background:${color}"></span></div>
        <div class="space"></div>`;
    }
    el.insertAdjacentHTML('beforeend', row('Proteine',P,TARGETS.p,'g'));
    el.insertAdjacentHTML('beforeend', row('Carbs',C,TARGETS.c,'g'));
    el.insertAdjacentHTML('beforeend', row('Grassi',F,TARGETS.f,'g'));
    el.insertAdjacentHTML('beforeend', row('Kcal',K,TARGETS.kcal,'kcal'));
  }
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id==='addMeal'){
      const m = {
        name:document.getElementById('mealName').value||'Custom', time:document.getElementById('mealTime').value||'',
        p:+document.getElementById('mealP').value||0, c:+document.getElementById('mealC').value||0, f:+document.getElementById('mealF').value||0, kcal:+document.getElementById('mealK').value||0
      };
      const dd = getDayData(); dd.meals.push(m); saveDayData(dd);
      document.getElementById('mealName').value=''; document.getElementById('mealTime').value=''; document.getElementById('mealP').value=0; document.getElementById('mealC').value=0; document.getElementById('mealF').value=0; document.getElementById('mealK').value=0;
    }
  });

  // ========= PROGRESS =========
  function getProgress(){ return store.get('progress', Array.from({length:TOTAL_WEEKS},(_,i)=>({week:i+1, weight:null, pullups:null, sleep:null, mood:5, notes:''}))); }
  function saveProgress(p){ store.set('progress',p); renderProgressForm(); renderStats(); if(window.Chart) drawChart(); }

  function renderProgressForm(){
    const holder = document.getElementById('progressForm'); holder.innerHTML='';
    const p = getProgress();
    p.forEach((w)=>{
      const box = document.createElement('div'); box.className='exercise'; box.style.alignItems='start';
      box.innerHTML = `
        <div class="chip">Week ${w.week}</div>
        <div>
          <div class="grid-2">
            <div><label>Peso (kg)</label><input type="number" step="0.1" value="${w.weight??''}" data-k="weight" data-w="${w.week}" /></div>
            <div><label>Max Pull-ups</label><input type="number" value="${w.pullups??''}" data-k="pullups" data-w="${w.week}" /></div>
          </div>
          <div class="grid-2">
            <div><label>Sleep (h)</label><input type="number" step="0.1" value="${w.sleep??''}" data-k="sleep" data-w="${w.week}" /></div>
            <div><label>Mood (1-10)</label><input type="range" min="1" max="10" value="${w.mood}" data-k="mood" data-w="${w.week}" /></div>
          </div>
          <div><label>Note</label><textarea data-k="notes" data-w="${w.week}">${w.notes||''}</textarea></div>
        </div>
        <div class="chip">${toISO(new Date(parseISO(START_ISO).getTime()+ (w.week-1)*7*DAY_MS))}</div>
      `;
      holder.appendChild(box);
    });
    holder.querySelectorAll('input,textarea').forEach(el=>{
      el.addEventListener('input',()=>{
        const p = getProgress(); const w = +el.dataset.w; const k = el.dataset.k; const i=w-1;
        let val = el.type==='range'?+el.value:(el.type==='number'? (el.value===''?null:+el.value):el.value);
        p[i][k]=val; saveProgress(p);
      });
    });
  }

  // Photos
  document.querySelectorAll('#photosContent input[type=file]').forEach(inp=>{
    inp.addEventListener('change', async ()=>{
      const file = inp.files[0]; if(!file) return; const url = await fileToDataURL(file);
      store.set('photo:'+inp.dataset.photokey, url); renderPhotos();
    });
  });
  function renderPhotos(){ ['w0','w4','w8','w12'].forEach(k=>{ const src = store.get('photo:'+k,null); const img=document.getElementById('img-'+k); if(src) img.src=src; }); }
  function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

  // Stats & chart
  let weightChart;
  function drawChart(){
    const ctx = document.getElementById('weightChart'); if(!ctx || !window.Chart) { return; }
    const p = getProgress();
    const labels = p.map(w=>`W${w.week}`);
    const data = p.map(w=> w.weight ?? null);
    if(weightChart) weightChart.destroy();
    weightChart = new Chart(ctx, { type:'line', data:{ labels, datasets:[{label:'Peso (kg)', data, tension:.3, pointRadius:4}] }, options:{ plugins:{legend:{display:false}}, scales:{x:{grid:{color:'#222'}}, y:{grid:{color:'#222'}}}} });
  }
  function renderStats(){
    const el = document.getElementById('statsContent'); const p = getProgress();
    const startW = +(document.getElementById('uStartW').value||74); const goal = +(document.getElementById('uGoal').value||78);
    const last = [...p].reverse().find(w=>w.weight!=null); const currentW = last?last.weight:startW;
    const gained = (currentW - startW).toFixed(1);
    const bestPull = Math.max(0, ...p.map(w=>w.pullups||0));
    const bestMood = Math.max(0, ...p.map(w=>w.mood||0));
    const daysLeft = Math.max(0, Math.ceil((parseISO(END_ISO) - new Date())/DAY_MS));
    el.innerHTML = `
      <div class="grid-2">
        <div class="exercise"><div class="name">Peso Attuale</div><div class="kpi">${currentW?currentW+' kg':'—'}</div></div>
        <div class="exercise"><div class="name">Aumento Totale</div><div class="kpi">${gained} kg</div></div>
      </div>
      <div class="grid-2">
        <div class="exercise"><div class="name">Max Pull-ups</div><div class="kpi">${bestPull}</div></div>
        <div class="exercise"><div class="name">Best Week (mood)</div><div class="kpi">${bestMood}/10</div></div>
      </div>
      <div class="grid-2">
        <div class="exercise"><div class="name">Goal Peso</div><div class="kpi">${goal} kg</div></div>
        <div class="exercise"><div class="name">Giorni alla fine</div><div class="kpi">${daysLeft}</div></div>
      </div>`;
  }

  // ========= SETTINGS =========
  function saveProfile(){
    const prof = {name:document.getElementById('uName').value, age:+document.getElementById('uAge').value, h:+document.getElementById('uHeight').value, start:+document.getElementById('uStartW').value, bf:+document.getElementById('uBf').value, goal:+document.getElementById('uGoal').value};
    store.set('profile',prof); renderStats();
    alert('Profilo salvato!');
  }
  function loadProfile(){
    const prof = store.get('profile', null);
    if(prof){ document.getElementById('uName').value=prof.name; document.getElementById('uAge').value=prof.age; document.getElementById('uHeight').value=prof.h; document.getElementById('uStartW').value=prof.start; document.getElementById('uBf').value=prof.bf; document.getElementById('uGoal').value=prof.goal; }
  }
  function renderPhaseInfo(){
    const iso = toISO(new Date());
    const w = weekFromDate(iso); const ph = phaseFromWeek(w);
    const pc = document.getElementById('phaseContent');
    pc.innerHTML = `
      <div class="row">
        <span class="chip">Today ${iso}</span>
        <span class="chip">Week ${w}/${TOTAL_WEEKS}</span>
        <span class="chip">Phase ${ph.id}: ${ph.name}</span>
      </div>
      <div class="space"></div>
      <div class="muted">${ph.desc}</div>`;

    const info = document.getElementById('infoContent');
    info.innerHTML = `
      <div class="grid-2">
        ${PHASES.map(p=>`<div class="exercise"><div class="name">Phase ${p.id}: ${p.name}</div><div class="meta">Weeks ${p.weeks[0]}-${p.weeks[p.weeks.length-1]} · Days: ${p.days.join(', ')} · RPE ${p.rpe}</div></div>`).join('')}
      </div>
      <div class="space"></div>
      <div class="exercise"><div><div class="name">Target Giornalieri</div><div class="meta">P ${TARGETS.p}g · C ${TARGETS.c}g · F ${TARGETS.f}g · ${TARGETS.kcal} kcal</div></div></div>
    `;
  }

  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id==='saveProfile') saveProfile();
    if(e.target && e.target.id==='toggleTheme'){
      const light = document.body.dataset.theme==='light';
      if(light){ delete document.body.dataset.theme; document.documentElement.style.setProperty('--bg','#0f0f10'); document.documentElement.style.setProperty('--text','#ffffff'); }
      else { document.body.dataset.theme='light'; document.documentElement.style.setProperty('--bg','#ffffff'); document.documentElement.style.setProperty('--text','#111111'); }
    }
  });

  // Backup
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id==='exportBtn'){
      const blob = new Blob([JSON.stringify(localStorage, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'dominance-tracker-backup.json'; a.click();
    }
  });
  document.getElementById('importFile').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return; const txt = await file.text();
    try{
      const obj = JSON.parse(txt); if(obj){ localStorage.clear(); Object.keys(obj).forEach(k=> localStorage.setItem(k, obj[k])); location.reload(); }
    }catch(err){ alert('File non valido'); }
  });
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id==='resetAll'){ if(confirm('Confermi reset totale?')) { localStorage.clear(); location.reload(); } }
  });

  // ========= NAV =========
  function openTab(name){
    document.querySelectorAll('section.container').forEach(s=>s.hidden=true);
    document.getElementById('tab-'+name).hidden=false;
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById('nav-'+name).classList.add('active');
    if(name==='progress' && window.Chart){ drawChart(); }
  }
  document.querySelectorAll('.tab').forEach(t=> t.addEventListener('click', (e)=>{ e.preventDefault(); openTab(t.dataset.tab); }));

  // ========= PWA =========
  let deferredPrompt=null; window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; document.getElementById('installBtn').hidden=false; });
  document.getElementById('installBtn').onclick = async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); const {outcome}= await deferredPrompt.userChoice; if(outcome==='accepted') document.getElementById('installBtn').hidden=true; };

  async function init(){
    if('serviceWorker' in navigator){
      try{ await navigator.serviceWorker.register('/sw.js'); }catch(e){ console.warn('SW failed', e); }
    }

    renderToday();
    renderMeals();
    renderMacros();
    renderProgressForm();
    renderPhotos();
    renderStats();
    loadProfile();
    renderPhaseInfo();

    try {
      await loadChartJS();
      if(window.Chart){ drawChart(); document.getElementById('chartFallback').style.display='none'; }
    } catch(err){
      console.warn('Chart.js non disponibile:', err);
      document.getElementById('chartFallback').style.display='block';
    }

    document.getElementById('timerStart').onclick=startTimer; document.getElementById('timerStop').onclick=stopTimer; document.getElementById('timerReset').onclick=resetTimer; updateTimerUI();
  }
  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
